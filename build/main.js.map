{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from '@iobroker/adapter-core';\n\nimport { SpreadsheetUtils } from './lib/google';\nimport {\n    handleAppend,\n    handleDeleteRows,\n    handleCreateSheet,\n    handleDeleteSheet,\n    handleDeleteSheets,\n    handleDuplicateSheet,\n    handleUpload,\n    handleWriteCell,\n    handleWriteCells,\n    handleReadCell,\n} from './lib/messageHandlers/index';\n\n/**\n * The adapter class\n */\nclass GoogleSpreadsheet extends utils.Adapter {\n    private spreadsheet: SpreadsheetUtils;\n\n    /**\n     * Creates an instance of the adapter class.\n     *\n     * @param options The adapter options\n     */\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'google-spreadsheet',\n        });\n        this.on('ready', this.onReady.bind(this));\n        this.on('message', this.onMessage.bind(this));\n        this.on('unload', this.onUnload.bind(this));\n        this.spreadsheet = new SpreadsheetUtils(this.config, this.log);\n    }\n\n    private migrateSpreadhseetIdToTableIfNeeded(): void {\n        if (\n            this.config.spreadsheetId &&\n            this.config.spreadsheetId.length > 0 &&\n            (!this.config.spreadsheets || this.config.spreadsheets.length === 0)\n        ) {\n            this.log.info(`Migrating spreadsheetId ${this.config.spreadsheetId} to spreadsheets table`);\n            this.config.spreadsheets = [\n                {\n                    spreadsheetId: this.config.spreadsheetId,\n                    alias: 'default',\n                    isDefault: true,\n                },\n            ];\n            this.config.spreadsheetId = '';\n            this.extendForeignObject(`system.adapter.${this.name}.${this.instance}`, { native: this.config }, () => {\n                this.log.info('Migration completed');\n            });\n        }\n    }\n    /**\n     * Is called when databases are connected and adapter received configuration.\n     */\n    private async onReady(): Promise<void> {\n        // Initialize your adapter here\n        this.migrateSpreadhseetIdToTableIfNeeded();\n\n        if (this.config.privateKey && this.config.serviceAccountEmail && this.config.spreadsheets.length > 0) {\n            await this.setState('info.connection', true, true);\n            this.log.info('Google-spreadsheet adapter configured');\n        } else {\n            await this.setState('info.connection', false, true);\n            this.log.warn('Google-spreadsheet adapter not configured');\n        }\n        await this.encryptPrivateKeyIfNeeded();\n\n        this.spreadsheet = new SpreadsheetUtils(this.config, this.log);\n    }\n\n    private async encryptPrivateKeyIfNeeded(): Promise<void> {\n        if (this.config.privateKey && this.config.privateKey.length > 0) {\n            await this.getForeignObjectAsync(`system.adapter.${this.name}.${this.instance}`).then(data => {\n                if (data && data.native && data.native.privateKey && !data.native.privateKey.startsWith('$/aes')) {\n                    this.config.privateKey = data.native.privateKey;\n                    data.native.privateKey = this.encrypt(data.native.privateKey);\n                    this.extendForeignObject(`system.adapter.${this.name}.${this.instance}`, data)\n                        .then(() => {\n                            this.log.info('privateKey is stored now encrypted');\n                        })\n                        .catch(err => {\n                            this.log.error(`Cannot store encrypted privateKey: ${err}`);\n                        });\n                }\n            });\n        }\n    }\n\n    /**\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\n     *\n     * @param callback Callback so the adapter can shut down\n     */\n    private onUnload(callback: () => void): void {\n        try {\n            callback();\n        } catch (e) {\n            this.log.error(`Error during unload: ${JSON.stringify(e)}`);\n            callback();\n        }\n    }\n\n    /**\n     * Some message was sent to this instance over message box. Used by email, pushover, text2speech, ...\n     * Using this method requires \"common.messagebox\" property to be set to true in io-package.json\n     *\n     * @param obj The message object\n     */\n    private onMessage(obj: ioBroker.Message): void {\n        const handlers = {\n            append: { handler: handleAppend, logMessage: 'append to spreadsheet' },\n            deleteRows: { handler: handleDeleteRows, logMessage: 'delete rows from spreadsheet' },\n            createSheet: { handler: handleCreateSheet, logMessage: 'create sheet' },\n            deleteSheet: { handler: handleDeleteSheet, logMessage: 'delete sheet' },\n            deleteSheets: { handler: handleDeleteSheets, logMessage: 'delete sheets' },\n            duplicateSheet: { handler: handleDuplicateSheet, logMessage: 'duplicate sheet' },\n            upload: { handler: handleUpload, logMessage: 'upload file' },\n            writeCell: { handler: handleWriteCell, logMessage: 'write cell' },\n            writeCells: { handler: handleWriteCells, logMessage: 'write cells' },\n            readCell: { handler: handleReadCell, logMessage: 'read cell' },\n        };\n\n        this.log.debug(`Received message: ${JSON.stringify(obj)}`);\n        if (typeof obj === 'object' && obj.message) {\n            if (obj.command && obj.command in handlers) {\n                const command = obj.command as keyof typeof handlers;\n                this.log.debug(handlers[command].logMessage);\n                handlers[command]\n                    .handler(this.spreadsheet, this.log, obj)\n                    .then((result: any) => {\n                        if (obj.callback) {\n                            this.sendTo(obj.from, obj.command, result ? result : 'Message received', obj.callback);\n                        }\n                    })\n                    .catch((error: Error) => {\n                        this.log.error(`Cannot ${obj.command}: ${error}`);\n                        if (obj.callback) {\n                            this.sendTo(obj.from, obj.command, { error: error.message }, obj.callback);\n                        }\n                    });\n            } else {\n                this.log.warn(`unknown command: ${obj.command}`);\n            }\n        }\n    }\n}\n\nexport { GoogleSpreadsheet };\n\nif (require.main !== module) {\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new GoogleSpreadsheet(options);\n    module.exports.GoogleSpreadsheet = GoogleSpreadsheet;\n} else {\n    (() => new GoogleSpreadsheet())();\n}\n"],
  "mappings": "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",
  "names": []
}
