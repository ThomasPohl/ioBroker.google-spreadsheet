{
  "version": 3,
  "sources": ["../../src/lib/google.ts"],
  "sourcesContent": ["import { google, sheets_v4 } from \"googleapis\";\r\nimport { JWT } from \"google-auth-library\";\r\n\r\nexport class SpreadsheetUtils {\r\n\r\n    public constructor(private config: ioBroker.AdapterConfig, private log: ioBroker.Log) {\r\n    }\r\n\r\n    public deleteRows(sheetName:string, start:number, end:number): void {\r\n        const sheets = this.init();\r\n\r\n        sheets.spreadsheets.get({spreadsheetId: this.config.spreadsheetId}).then(spreadsheet => {\r\n            if (spreadsheet && spreadsheet.data.sheets) {\r\n                const sheet = spreadsheet.data.sheets\r\n                    .find(sheet => sheet.properties && sheet.properties.title ==sheetName);\r\n                if (sheet && sheet.properties) {\r\n                    const sheetId = sheet.properties.sheetId;\r\n                    sheets.spreadsheets.batchUpdate(\r\n                        {\r\n                            spreadsheetId: this.config.spreadsheetId,\r\n                            requestBody: {\r\n                                requests: [{\r\n                                    deleteDimension: {\r\n                                        range: {\r\n                                            dimension: \"ROWS\",\r\n                                            endIndex: end,\r\n                                            sheetId: sheetId,\r\n                                            startIndex: start-1\r\n                                        }\r\n                                    }\r\n                                }]\r\n                            }\r\n                        }\r\n\r\n                    ).then(() => {\r\n                        this.log.debug(\"Rows successfully deleted from google spreadsheet\");\r\n                    }).catch(error => {\r\n                        this.log.error(\"Error while deleting rows from Google Spreadsheet:\" + error);\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n\r\n    }\r\n\r\n    private init(): sheets_v4.Sheets{\r\n        const auth = new JWT({\r\n            email: this.config.serviceAccountEmail,\r\n            key: this.formatPrivateKey(this.config.privateKey),\r\n            scopes: [\"https://www.googleapis.com/auth/spreadsheets\"]\r\n        });\r\n        return google.sheets({ version: \"v4\", auth });\r\n    }\r\n\r\n    public createSheet(title: string): void{\r\n        const sheets = this.init();\r\n\r\n        sheets.spreadsheets.batchUpdate({\r\n            spreadsheetId: this.config.spreadsheetId,\r\n            requestBody: {\r\n                requests:[{addSheet:{\r\n                    properties:{\r\n                        title: title\r\n                    }\r\n                }}]\r\n            }\r\n        }).then(() => {\r\n            this.log.debug(\"Sheet created successfully\");\r\n        }).catch(error => {\r\n            this.log.error(\"Error while creating sheet:\"+ error);\r\n        });\r\n\r\n    }\r\n\r\n\r\n\r\n    public duplicateSheet(source: string, target: string, index: number): void {\r\n        const sheets = this.init();\r\n\r\n\r\n        sheets.spreadsheets.get({ spreadsheetId: this.config.spreadsheetId as string }).then(spreadsheet => {\r\n            if (spreadsheet && spreadsheet.data.sheets) {\r\n                const sheet = spreadsheet.data.sheets\r\n                    .find(sheet => sheet.properties && sheet.properties.title == source);\r\n                if (sheet && sheet.properties) {\r\n                    let insertIndex = index;\r\n                    if (insertIndex==-1 || insertIndex == undefined){\r\n                        insertIndex = spreadsheet.data.sheets.length;\r\n                    }\r\n                    sheets.spreadsheets.batchUpdate({\r\n                        spreadsheetId: this.config.spreadsheetId,\r\n                        requestBody: {\r\n                            requests: [{\r\n                                duplicateSheet: {\r\n                                    sourceSheetId: sheet.properties.sheetId,\r\n                                    newSheetName: target,\r\n                                    insertSheetIndex: insertIndex\r\n                                }\r\n                            }]\r\n                        }\r\n                    }).then(() => {\r\n                        this.log.debug(\"Data successfully sent to google spreadsheet\");\r\n                    }).catch(error => {\r\n                        this.log.error(\"Error while sending data to Google Spreadsheet:\" + error);\r\n                    });\r\n                } else {\r\n                    this.log.warn(\"Cannot find sheet: \" + source);\r\n                }\r\n            }\r\n        }).catch(error => {\r\n            this.log.error(\"Error while sending data to Google Spreadsheet:\" + error);\r\n        });\r\n\r\n\r\n    }\r\n    public upload(source:string, target:string, parentFolder:string, filecontent:any): void {\r\n\r\n\r\n        const auth = new JWT({\r\n            email: this.config.serviceAccountEmail,\r\n            key: this.config.privateKey,\r\n            scopes: [\"https://www.googleapis.com/auth/drive.file\"]\r\n        });\r\n        const driveapi = google.drive({ version: \"v3\", auth });\r\n\r\n\r\n        driveapi.files.create({\r\n            requestBody:{\r\n                parents: [parentFolder],\r\n                name: target\r\n            },\r\n            media:{\r\n                mimeType: \"application/octet-stream\",\r\n                body: filecontent\r\n            },\r\n            fields: \"id\"\r\n        }).then(() => {\r\n            this.log.debug(\"Data successfully uploaded to google spreadsheet\");\r\n        }).catch(error => {\r\n            this.log.error(\"Error while uploading data to Google Spreadsheet:\" + error);\r\n        });\r\n    }\r\n\r\n\r\n\r\n    public deleteSheet(title: string): void {\r\n        const sheets = this.init();\r\n\r\n        sheets.spreadsheets.get({ spreadsheetId: this.config.spreadsheetId as string }).then(spreadsheet => {\r\n            if (spreadsheet && spreadsheet.data.sheets) {\r\n                const sheet = spreadsheet.data.sheets\r\n                    .find(sheet => sheet.properties && sheet.properties.title == title);\r\n                if (sheet && sheet.properties) {\r\n                    sheets.spreadsheets.batchUpdate({\r\n                        spreadsheetId: this.config.spreadsheetId,\r\n                        requestBody: {\r\n                            requests: [{\r\n                                deleteSheet: {\r\n                                    sheetId: sheet.properties.sheetId\r\n                                }\r\n                            }]\r\n                        }\r\n                    }).then(() => {\r\n                        this.log.debug(\"Data successfully sent to google spreadsheet\");\r\n                    }).catch(error => {\r\n                        this.log.error(\"Error while sending data to Google Spreadsheet:\" + error);\r\n                    });\r\n                }\r\n            }\r\n        }).catch(error => {\r\n            this.log.error(\"Error while sending data to Google Spreadsheet:\" + error);\r\n        });\r\n\r\n\r\n    }\r\n\r\n\r\n\r\n    public append(sheetName:string, data:any): void{\r\n        const sheets = this.init();\r\n\r\n\r\n        sheets.spreadsheets.values.append({\r\n            // The [A1 notation](/sheets/api/guides/concepts#cell) of a range to search for a logical table of data. Values are appended after the last row of the table.\r\n            range: sheetName,\r\n            spreadsheetId: this.config.spreadsheetId,\r\n            valueInputOption: \"USER_ENTERED\",\r\n            // Request body metadata\r\n            requestBody: {\r\n                values: this.prepareValues(data)\r\n            },\r\n        }).then(() => {\r\n            this.log.debug(\"Data successfully sent to google spreadsheet\");\r\n        }).catch(error => {\r\n            this.log.error(\"Error while sending data to Google Spreadsheet:\"+ error);\r\n        });\r\n\r\n    }\r\n\r\n    private prepareValues(message: any) : any{\r\n        if (Array.isArray(message)){\r\n            return [message];\r\n\r\n        } else {\r\n            return [[message]];\r\n        }\r\n\r\n    }\r\n    private formatPrivateKey(privateKey: string): string | undefined {\r\n        //replace all \\n with line breaks\r\n        if (privateKey) {\r\n            return privateKey.replace(/\\\\n/g, \"\\n\");\r\n        } else {\r\n            return undefined;\r\n        }\r\n    }\r\n\r\n}\r\n\r\n\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wBAAkC;AAClC,iCAAoB;AAEb,MAAM,iBAAiB;AAAA,EAEnB,YAAoB,QAAwC,KAAmB;AAA3D;AAAwC;AAAA,EACnE;AAAA,EAEO,WAAW,WAAkB,OAAc,KAAkB;AAChE,UAAM,SAAS,KAAK,KAAK;AAEzB,WAAO,aAAa,IAAI,EAAC,eAAe,KAAK,OAAO,cAAa,CAAC,EAAE,KAAK,iBAAe;AACpF,UAAI,eAAe,YAAY,KAAK,QAAQ;AACxC,cAAM,QAAQ,YAAY,KAAK,OAC1B,KAAK,CAAAA,WAASA,OAAM,cAAcA,OAAM,WAAW,SAAQ,SAAS;AACzE,YAAI,SAAS,MAAM,YAAY;AAC3B,gBAAM,UAAU,MAAM,WAAW;AACjC,iBAAO,aAAa;AAAA,YAChB;AAAA,cACI,eAAe,KAAK,OAAO;AAAA,cAC3B,aAAa;AAAA,gBACT,UAAU,CAAC;AAAA,kBACP,iBAAiB;AAAA,oBACb,OAAO;AAAA,sBACH,WAAW;AAAA,sBACX,UAAU;AAAA,sBACV;AAAA,sBACA,YAAY,QAAM;AAAA,oBACtB;AAAA,kBACJ;AAAA,gBACJ,CAAC;AAAA,cACL;AAAA,YACJ;AAAA,UAEJ,EAAE,KAAK,MAAM;AACT,iBAAK,IAAI,MAAM,mDAAmD;AAAA,UACtE,CAAC,EAAE,MAAM,WAAS;AACd,iBAAK,IAAI,MAAM,uDAAuD,KAAK;AAAA,UAC/E,CAAC;AAAA,QACL;AAAA,MACJ;AAAA,IACJ,CAAC;AAAA,EAGL;AAAA,EAEQ,OAAwB;AAC5B,UAAM,OAAO,IAAI,+BAAI;AAAA,MACjB,OAAO,KAAK,OAAO;AAAA,MACnB,KAAK,KAAK,iBAAiB,KAAK,OAAO,UAAU;AAAA,MACjD,QAAQ,CAAC,8CAA8C;AAAA,IAC3D,CAAC;AACD,WAAO,yBAAO,OAAO,EAAE,SAAS,MAAM,KAAK,CAAC;AAAA,EAChD;AAAA,EAEO,YAAY,OAAoB;AACnC,UAAM,SAAS,KAAK,KAAK;AAEzB,WAAO,aAAa,YAAY;AAAA,MAC5B,eAAe,KAAK,OAAO;AAAA,MAC3B,aAAa;AAAA,QACT,UAAS,CAAC,EAAC,UAAS;AAAA,UAChB,YAAW;AAAA,YACP;AAAA,UACJ;AAAA,QACJ,EAAC,CAAC;AAAA,MACN;AAAA,IACJ,CAAC,EAAE,KAAK,MAAM;AACV,WAAK,IAAI,MAAM,4BAA4B;AAAA,IAC/C,CAAC,EAAE,MAAM,WAAS;AACd,WAAK,IAAI,MAAM,gCAA+B,KAAK;AAAA,IACvD,CAAC;AAAA,EAEL;AAAA,EAIO,eAAe,QAAgB,QAAgB,OAAqB;AACvE,UAAM,SAAS,KAAK,KAAK;AAGzB,WAAO,aAAa,IAAI,EAAE,eAAe,KAAK,OAAO,cAAwB,CAAC,EAAE,KAAK,iBAAe;AAChG,UAAI,eAAe,YAAY,KAAK,QAAQ;AACxC,cAAM,QAAQ,YAAY,KAAK,OAC1B,KAAK,CAAAA,WAASA,OAAM,cAAcA,OAAM,WAAW,SAAS,MAAM;AACvE,YAAI,SAAS,MAAM,YAAY;AAC3B,cAAI,cAAc;AAClB,cAAI,eAAa,MAAM,eAAe,QAAU;AAC5C,0BAAc,YAAY,KAAK,OAAO;AAAA,UAC1C;AACA,iBAAO,aAAa,YAAY;AAAA,YAC5B,eAAe,KAAK,OAAO;AAAA,YAC3B,aAAa;AAAA,cACT,UAAU,CAAC;AAAA,gBACP,gBAAgB;AAAA,kBACZ,eAAe,MAAM,WAAW;AAAA,kBAChC,cAAc;AAAA,kBACd,kBAAkB;AAAA,gBACtB;AAAA,cACJ,CAAC;AAAA,YACL;AAAA,UACJ,CAAC,EAAE,KAAK,MAAM;AACV,iBAAK,IAAI,MAAM,8CAA8C;AAAA,UACjE,CAAC,EAAE,MAAM,WAAS;AACd,iBAAK,IAAI,MAAM,oDAAoD,KAAK;AAAA,UAC5E,CAAC;AAAA,QACL,OAAO;AACH,eAAK,IAAI,KAAK,wBAAwB,MAAM;AAAA,QAChD;AAAA,MACJ;AAAA,IACJ,CAAC,EAAE,MAAM,WAAS;AACd,WAAK,IAAI,MAAM,oDAAoD,KAAK;AAAA,IAC5E,CAAC;AAAA,EAGL;AAAA,EACO,OAAO,QAAe,QAAe,cAAqB,aAAuB;AAGpF,UAAM,OAAO,IAAI,+BAAI;AAAA,MACjB,OAAO,KAAK,OAAO;AAAA,MACnB,KAAK,KAAK,OAAO;AAAA,MACjB,QAAQ,CAAC,4CAA4C;AAAA,IACzD,CAAC;AACD,UAAM,WAAW,yBAAO,MAAM,EAAE,SAAS,MAAM,KAAK,CAAC;AAGrD,aAAS,MAAM,OAAO;AAAA,MAClB,aAAY;AAAA,QACR,SAAS,CAAC,YAAY;AAAA,QACtB,MAAM;AAAA,MACV;AAAA,MACA,OAAM;AAAA,QACF,UAAU;AAAA,QACV,MAAM;AAAA,MACV;AAAA,MACA,QAAQ;AAAA,IACZ,CAAC,EAAE,KAAK,MAAM;AACV,WAAK,IAAI,MAAM,kDAAkD;AAAA,IACrE,CAAC,EAAE,MAAM,WAAS;AACd,WAAK,IAAI,MAAM,sDAAsD,KAAK;AAAA,IAC9E,CAAC;AAAA,EACL;AAAA,EAIO,YAAY,OAAqB;AACpC,UAAM,SAAS,KAAK,KAAK;AAEzB,WAAO,aAAa,IAAI,EAAE,eAAe,KAAK,OAAO,cAAwB,CAAC,EAAE,KAAK,iBAAe;AAChG,UAAI,eAAe,YAAY,KAAK,QAAQ;AACxC,cAAM,QAAQ,YAAY,KAAK,OAC1B,KAAK,CAAAA,WAASA,OAAM,cAAcA,OAAM,WAAW,SAAS,KAAK;AACtE,YAAI,SAAS,MAAM,YAAY;AAC3B,iBAAO,aAAa,YAAY;AAAA,YAC5B,eAAe,KAAK,OAAO;AAAA,YAC3B,aAAa;AAAA,cACT,UAAU,CAAC;AAAA,gBACP,aAAa;AAAA,kBACT,SAAS,MAAM,WAAW;AAAA,gBAC9B;AAAA,cACJ,CAAC;AAAA,YACL;AAAA,UACJ,CAAC,EAAE,KAAK,MAAM;AACV,iBAAK,IAAI,MAAM,8CAA8C;AAAA,UACjE,CAAC,EAAE,MAAM,WAAS;AACd,iBAAK,IAAI,MAAM,oDAAoD,KAAK;AAAA,UAC5E,CAAC;AAAA,QACL;AAAA,MACJ;AAAA,IACJ,CAAC,EAAE,MAAM,WAAS;AACd,WAAK,IAAI,MAAM,oDAAoD,KAAK;AAAA,IAC5E,CAAC;AAAA,EAGL;AAAA,EAIO,OAAO,WAAkB,MAAe;AAC3C,UAAM,SAAS,KAAK,KAAK;AAGzB,WAAO,aAAa,OAAO,OAAO;AAAA,MAE9B,OAAO;AAAA,MACP,eAAe,KAAK,OAAO;AAAA,MAC3B,kBAAkB;AAAA,MAElB,aAAa;AAAA,QACT,QAAQ,KAAK,cAAc,IAAI;AAAA,MACnC;AAAA,IACJ,CAAC,EAAE,KAAK,MAAM;AACV,WAAK,IAAI,MAAM,8CAA8C;AAAA,IACjE,CAAC,EAAE,MAAM,WAAS;AACd,WAAK,IAAI,MAAM,oDAAmD,KAAK;AAAA,IAC3E,CAAC;AAAA,EAEL;AAAA,EAEQ,cAAc,SAAmB;AACrC,QAAI,MAAM,QAAQ,OAAO,GAAE;AACvB,aAAO,CAAC,OAAO;AAAA,IAEnB,OAAO;AACH,aAAO,CAAC,CAAC,OAAO,CAAC;AAAA,IACrB;AAAA,EAEJ;AAAA,EACQ,iBAAiB,YAAwC;AAE7D,QAAI,YAAY;AACZ,aAAO,WAAW,QAAQ,QAAQ,IAAI;AAAA,IAC1C,OAAO;AACH,aAAO;AAAA,IACX;AAAA,EACJ;AAEJ;",
  "names": ["sheet"]
}
